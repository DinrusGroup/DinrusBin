/*******************************************************************************

        Copyright: Copyright (C) 2008 Kris Bell.  все rights reserved.

        License:   BSD стиль: $(LICENSE)

        version:   Initial release: March 2008      

        Authors:   Kris

*******************************************************************************/

module text.xml.DocTester;

private import exception;

private import text.xml.Document;

private import text.convert.Format;

/*******************************************************************************

        Valопрate a document

        TODO: добавь various tests here, or in subclasses, as требуется

*******************************************************************************/

protected class DocTester(T)
{
        private alias Документ!(T) Док;         /// the typed document
        private alias Док.Узел     Узел;        /// генерный document узел

        /***********************************************************************
        
                Generate a текст representation of the document дерево

        ***********************************************************************/
        
        final проц оцени (Док doc)
        {     
                оцени (doc.элементы);  
        }
        
        /***********************************************************************
        
                Generate a representation of the given узел-subtree 

        ***********************************************************************/
        
        final проц оцени (Узел узел)
        {
                switch (узел.опр)
                       {
                       case ПТипУзлаРЯР.Документ:
                            foreach (n; узел.ветви)
                                     оцени (n);
                            break;
        
                       case ПТипУзлаРЯР.Элемент:
                            элемент (узел);

                            foreach (n; узел.атрибуты)
                                     attribute (n);

                            foreach (n; узел.ветви)
                                     оцени (n);
                            break;
        
                       case ПТипУзлаРЯР.Атрибут:
                            attribute (узел);
                            break;
        
                       case ПТипУзлаРЯР.Данные:
                            данные (узел);
                            break;
        
                       case ПТипУзлаРЯР.Комментарий:
                            коммент (узел);
                            break;
        
                       case ПТипУзлаРЯР.ПИ:
                            pi (узел);
                            break;
                
                       case ПТипУзлаРЯР.СиДанные:
                            cdata (узел);
                            break;
                
                       case ПТипУзлаРЯР.Доктип:
                            doctype (узел);
                            break;
                       }
        }

        /***********************************************************************
        
                оцени an элемент

        ***********************************************************************/
        
        проц элемент (Узел узел)
        {
                uniqueAttrNames (узел);
        }

        /***********************************************************************
        
                оцени an attribute

        ***********************************************************************/
        
        проц attribute (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a данные узел

        ***********************************************************************/
        
        проц данные (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a коммент узел

        ***********************************************************************/
        
        проц коммент (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a pi узел

        ***********************************************************************/
        
        проц pi (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a cdata узел

        ***********************************************************************/
        
        проц cdata (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a doctype узел

        ***********************************************************************/
        
        проц doctype (Узел узел)
        {
        }

        /***********************************************************************
        
                Ensure attribute names are unique внутри the элемент 

        ***********************************************************************/
        
        static проц uniqueAttrNames (Узел узел)
        {
                T[128]  name1 =void,
                        name2 =void;

                // non-optimal, but is it critical?
                foreach (атр; узел.атрибуты)
                        {
                        auto имя = атр.имя (name1);
                        auto следщ = атр.nextSibling;
                        while (следщ !is пусто)
                              {
                              if (имя == следщ.имя(name2))
                                  ошибка ("дубликат attribute имя '{}' for элемент '{}'", 
                                          имя, узел.имя(name2));
                              следщ = атр.nextSibling;
                              }
                        }
        }

        /***********************************************************************
        
                остановись validation

        ***********************************************************************/
        
        static проц ошибка (ткст форматируй, ...)
        {
                throw new TextException (Формат.преобразуй(_arguments, _argptr, форматируй));
        }
}




/*******************************************************************************

*******************************************************************************/

debug (DocTester)
{
        проц main()
        {
                auto v = new DocTester!(сим);
        }
}
